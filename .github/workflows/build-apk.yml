name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Install yarn
        run: npm install -g yarn

      - name: Configure git to use HTTPS instead of SSH
        run: git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"

      - name: Remove problematic scripts from package.json
        run: |
          cd front-end
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            delete pkg.scripts.preinstall;
            delete pkg.scripts.postinstall;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('Removed preinstall and postinstall scripts');
          "

      - name: Install dependencies
        run: |
          cd front-end
          yarn install --network-timeout 300000 || yarn install --network-timeout 300000 --no-lockfile
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Apply patches manually
        working-directory: front-end
        run: |
          node << 'NODESCRIPT'
          const fs = require('fs');
          const path = require('path');

          function patchFile(filePath, description, transform) {
            if (!fs.existsSync(filePath)) {
              console.log('WARNING: ' + filePath + ' not found - skipping ' + description);
              return false;
            }
            const original = fs.readFileSync(filePath, 'utf8');
            const patched = transform(original);
            if (patched !== original) {
              fs.writeFileSync(filePath, patched);
              console.log('APPLIED: ' + description);
              return true;
            }
            console.log('SKIPPED (already patched or no match): ' + description);
            return false;
          }

          // Patch 1: react-navigation-stack useTheme.js
          // This fixes crash caused by importing useTheme from react-navigation v4 API
          // when using react-navigation v2
          console.log('\n=== Patch 1: react-navigation-stack useTheme.js ===');
          const useThemePath = 'node_modules/react-navigation-stack/lib/module/utils/useTheme.js';
          if (fs.existsSync(useThemePath)) {
            const newContent = [
              "import * as React from 'react';",
              "const ThemeColors = {",
              "  light: { header: '#fff', label: '#000', headerBorder: '#ccc' },",
              "  dark: { header: '#000', label: '#fff', headerBorder: '#333' }",
              "};",
              "export default function useTheme() {",
              "  const theme = 'light';",
              "  return React.useMemo(function() {",
              "    var colors = ThemeColors[theme];",
              "    var dark = theme === 'dark';",
              "    return { colors: colors, dark: dark };",
              "  }, [theme]);",
              "}",
              ""
            ].join('\n');
            fs.writeFileSync(useThemePath, newContent);
            console.log('APPLIED: useTheme.js rewritten for react-navigation v2 compat');
          } else {
            console.log('WARNING: useTheme.js not found');
          }

          // Patch 2: react-native-push-notification PendingIntent (Android 12+ compat)
          console.log('\n=== Patch 2: PendingIntent fix for Android 12+ ===');
          patchFile(
            'node_modules/react-native-push-notification/android/src/main/java/com/dieam/reactnativepushnotification/modules/RNPushNotificationHelper.java',
            'PendingIntent FLAG_MUTABLE for Android 12+',
            function(content) {
              if (content.includes('FLAG_MUTABLE')) return content;
              return content.replace(
                /PendingIntent\s+pendingIntent\s*=\s*PendingIntent\.getActivity\(context,\s*notificationID,\s*intent,\s*\n\s*PendingIntent\.FLAG_UPDATE_CURRENT\);/g,
                [
                  'PendingIntent pendingIntent = null;',
                  '            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {',
                  '                pendingIntent = PendingIntent.getActivity(context, notificationID, intent, PendingIntent.FLAG_MUTABLE);',
                  '            } else {',
                  '                pendingIntent = PendingIntent.getActivity(context, notificationID, intent, PendingIntent.FLAG_UPDATE_CURRENT);',
                  '            }'
                ].join('\n')
              );
            }
          );

          // Patch 3: react-native-material-dropdown propTypes fix
          console.log('\n=== Patch 3: material-dropdown propTypes ===');
          var mdBase = 'node_modules/react-native-material-dropdown/node_modules/react-native-material-textfield/src/components';
          ['affix', 'helper', 'label'].forEach(function(comp) {
            var target = path.join(mdBase, comp, 'index.js');
            patchFile(target, comp + '/index.js propTypes fix', function(c) {
              c = c.replace(/Animated\.Text\.propTypes?\.style/g, 'Text.propType');
              c = c.replace("import { Animated } from 'react-native'", "import { Animated, Text } from 'react-native'");
              c = c.replace("import { View, Animated } from 'react-native'", "import { View, Animated, Text } from 'react-native'");
              return c;
            });
          });

          console.log('\n=== All patches processed ===');
          NODESCRIPT

      - name: Verify patches applied
        working-directory: front-end
        run: |
          echo "=== useTheme.js content ==="
          cat node_modules/react-navigation-stack/lib/module/utils/useTheme.js
          echo ""
          echo "=== PendingIntent check ==="
          grep -c "FLAG_MUTABLE" node_modules/react-native-push-notification/android/src/main/java/com/dieam/reactnativepushnotification/modules/RNPushNotificationHelper.java && echo "PendingIntent PATCHED" || echo "PendingIntent NOT patched"

      - name: Make gradlew executable
        run: chmod +x front-end/packages/mobile/android/gradlew

      - name: Accept Android SDK licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Pre-bundle JS assets
        working-directory: front-end
        run: |
          mkdir -p packages/mobile/android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file packages/mobile/index.js \
            --bundle-output packages/mobile/android/app/src/main/assets/index.android.bundle \
            --assets-dest packages/mobile/android/app/src/main/res
          echo "=== Bundle created ==="
          ls -lh packages/mobile/android/app/src/main/assets/index.android.bundle

      - name: Build Release APK
        run: |
          cd front-end/packages/mobile/android
          ./gradlew assembleRelease -x bundleReleaseJsAndAssets
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=true -Xmx4g'

      - name: Verify APK contents
        run: |
          APK="front-end/packages/mobile/android/app/build/outputs/apk/release/app-release.apk"
          echo "=== APK size ==="
          ls -lh "$APK"
          echo ""
          echo "=== Checking for JS bundle ==="
          unzip -l "$APK" | grep -i "index.android.bundle" || echo "WARNING: JS bundle NOT found in APK!"
          echo ""
          echo "=== Checking for native libs ==="
          unzip -l "$APK" | grep "\.so$" | head -20
          echo ""
          echo "=== Checking for assets ==="
          unzip -l "$APK" | grep "assets/" | head -10

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: niya-release-apk
          path: front-end/packages/mobile/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30
